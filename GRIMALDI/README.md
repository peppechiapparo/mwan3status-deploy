# GRIMALDI fleet — reports and how-to

This folder contains reports and utilities related to the GRIMALDI fleet version checks.

Files
- `grimaldi_list_hostname.csv` — canonical list of hosts (hostname,ip)
- `check_report.csv` — HTTP-based quick version check (generated by `scripts/check_grimaldi_version.sh`). Columns: HOST,IP,REACHABLE,VERSION,OK,DETAILS
- `grimaldi_remaining.csv` — hosts currently offline (hostname,ip)
- `not_updated.csv` — hosts reachable but not updated to expected version (hostname,ip,detected_version)
- `deploy_report.csv` — Ansible deploy report (kept only if newer than `check_report.csv`)

How to regenerate the quick check (no Ansible required)

From repository root:

```bash
# run the HTTP-based check (no ansible needed). Override EXPECTED_VERSION if needed.
EXPECTED_VERSION=1.5 ./scripts/check_grimaldi_version.sh

# The script writes: GRIMALDI/check_report.csv
# To regenerate the two helper lists run:
awk -F, 'NR>1 && $3=="0"{print $1","$2}' GRIMALDI/check_report.csv > GRIMALDI/grimaldi_remaining.csv
awk -F, 'NR>1 && $3=="1" && $5!="true"{print $1","$2","$4}' GRIMALDI/check_report.csv > GRIMALDI/not_updated.csv
```

How to run the Ansible-based check (recommended for remediation)

This requires Ansible installed and SSH access to the devices. From repository root:

```bash
# generate inventory from CSV and run the playbook (wrapper script does that)
EXPECTED_VERSION=1.5 ./install_all_ansible.sh

# or run only on specific hosts (colon-separated list)
EXPECTED_VERSION=1.5 LIMIT=GRANDEFLORIDA ./install_all_ansible.sh
```

Notes
- The HTTP quick-check is intended as a fast sanity check; the Ansible playbook performs additional verification and can attempt to fix metadata or re-run helpers on the devices.
#: GRIMALDI deploy notes

This short note documents the runtime version handling used by the `updateMwan3StatusPage.sh`
deploy script and how to override the version value at deploy time.

Version canonicalization
-------------------------
The deploy script generates a machine-readable file on the device at `/www/data_usage/version.json`.
This JSON file is the canonical runtime metadata that monitoring tools and clients should use.

How the version is chosen
-------------------------
 - By default the script uses the hard-coded `WEBAPP_VERSION` variable inside the script (currently `1.5`).
- You can override the value at deploy-time by setting the environment variable
  `WEBAPP_VERSION_OVERRIDE` when invoking the script. The override will be written into
  `/www/data_usage/version.json` and reflected in the injected HTML comment `<!-- webapp-version: ... -->`.

Examples
--------
# Run locally and use the script default version:
/bin/sh /opt/updateMwan3StatusPage.sh

# Force a specific version value (useful from CI or manual deploy):
WEBAPP_VERSION_OVERRIDE="2.0" /bin/sh /opt/updateMwan3StatusPage.sh

CI note
-------
If you run deploys from CI, prefer to set `WEBAPP_VERSION_OVERRIDE` from your pipeline configuration
or release job so `version.json` reflects the released version. This avoids committing version
files into the repository and keeps the device runtime metadata deterministic.

Testing the result
------------------
 - Confirm `/www/data_usage/version.json` contains the expected `version` field.
 - Open `/www/data_usage/index.html` and verify the first line contains the `<!-- webapp-version: X -->`
  comment matching the version in `version.json`.

Permissions
-----------
The deploy script writes under `/www/data_usage/` and `/www/cgi-bin/`. Ensure the user running the script
has the necessary filesystem permissions on the target device (the deploy task typically copies the
script to `/opt` then runs it via SSH as root or an account with write access to `/www`).

Usage: `install_all_ansible.sh` options
--------------------------------------
The repository includes a wrapper script `install_all_ansible.sh` that prepares an Ansible inventory from
a CSV and runs the playbook `ansible/playbooks/deploy_grimaldi.yml`.

Supported environment variables / behavior:

- `CSV` (default: `GRIMALDI/grimaldi_list_hostname.csv`)
  Path to the CSV containing hostname,ip lines used to build the Ansible inventory.

- `REPO` (default: `peppechiapparo/mwan3status-deploy`)
  Repository used by the installer on the targets when remote download is allowed.

- `BRANCH` (default: `main`)
  Branch to use when fetching remote installer or artifacts.

- `FLEET` (default: `GRIMALDI`)
  Fleet name passed to the installer.

- `EXPECTED_VERSION` (default: `1.5`)
  The expected webapp version. The playbook/role will force `version.json` and the index.html comment
  to this value when requested. Use this for checks or to pin a version during deploy.

- `PING_THRESHOLD_MS` (default: `900`)
  Milliseconds threshold used by gating logic to mark a host `STANDBY` if latency is high.

- `LIMIT` (default: empty)
  Pass a colon-separated list of inventory hostnames to limit the run (e.g. `LIMIT=HOSTA:HOSTB`).

- `ANSIBLE_TAGS` (default: empty)
  Forward tags to `ansible-playbook` to run a subset of tasks (e.g. `ANSIBLE_TAGS=verify`).

Examples
--------

# Full fleet check and deploy (default CSV)
EXPECTED_VERSION=1.5 ./install_all_ansible.sh

# Run only on a single host (useful for debugging)
EXPECTED_VERSION=1.5 LIMIT=GRANDEFLORIDA ./install_all_ansible.sh

# Run only the verification tasks via tags (if playbook/roles support tags)
ANSIBLE_TAGS=verify EXPECTED_VERSION=1.5 ./install_all_ansible.sh

# Retry pending hosts after generating a report (the script contains a retry-pending mode)
./scripts/deploy_grimaldi_ansible.sh retry-pending

Workflow: generate report -> retry failures
----------------------------------------
1. Run the HTTP quick-check to get a fast view of who is updated and who is offline:

   EXPECTED_VERSION=1.5 ./scripts/check_grimaldi_version.sh

   This writes `GRIMALDI/check_report.csv` and the helper lists `GRIMALDI/grimaldi_remaining.csv` and
   `GRIMALDI/not_updated.csv`.

2. Use the Ansible wrapper to attempt remediation for the hosts in `not_updated.csv` or `grimaldi_remaining.csv`.
   Build a colon-separated host list from the CSV and pass it in `LIMIT`:

   LIMIT=$(awk -F, '{print $1}' GRIMALDI/not_updated.csv | paste -sd ':' -)
   EXPECTED_VERSION=1.5 LIMIT="$LIMIT" ./install_all_ansible.sh

   If you prefer a safe iterative approach, retry only a few hosts at a time by limiting `LIMIT` or by
   running `./scripts/deploy_grimaldi_ansible.sh limit HOST1:HOST2`.

3. Re-run the quick-check and compare reports to confirm success, then clear lists or prepare follow-up actions.

